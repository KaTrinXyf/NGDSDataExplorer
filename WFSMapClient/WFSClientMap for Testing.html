<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"></>
<title> WFS Map Client </title>
<meta name="author" content="Jessica Good Alisdairi"></>

<!-- Local versions of external libraries: OpenLayers 2.12-rc7, GeoExt 1.1, ExtJS 3.4.0,  -->
<script src="../Libraries/OpenLayers-2.12-rc7/OpenLayers.js" type="text/javascript"></script>
<script src="../Libraries/ext-3.4.0/adapter/ext/ext-base.js" type="text/javascript"></script>
<script src="../Libraries/ext-3.4.0/ext-all.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="../Libraries/ext-3.4.0/resources/css/ext-all.css"></link>
<script src="../Libraries/GeoExt/lib/GeoExt.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="../Libraries/GeoExt/resources/css/geoext-all-debug.css"></link>
<script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>

<script type="text/javascript">
// Global Variables
var map;				// The map
var polyLayer;			// User-drawn polygon
var wfsLayers = [];  	// Array of WFS Layers
var j = 0;				// Variable to keep track of the number of layers added
var popup;				// The popup for the description of a feature
var showPopups = false;	// We don't want to show popups until user has clicked 'show popups' button
var activeLayer;		// Current active layer
var activeFeatures = [];// Array of active features
var selFeatures = [];	// Array of selected features across all layers
var numOfAttributes;   	// Only needed for EXCEL - can delete
var layerAttributes;	// The attributes of the layer
var usedUrls = [];		// Array of base Urls that have been used already
var selectCtrl; 		// Control for the selection features

// Projections
var wgs84 = new OpenLayers.Projection("EPSG:4326");
var googleMercator = new OpenLayers.Projection("EPSG:900913");

// Array to track of the colors used to display the features so there is no repetition
// Add black & the same yellow used for selected features to the list
var usedColors = ['#000000','#080000','#100000','#200000','#280000','#300000','#FFFF00','#FFFF33']; 

Ext.onReady(function() {
	// Initialize QuickTips for toolbar tips on mouseover
	Ext.QuickTips.init();
	
	// Initialize the map          
	map = new OpenLayers.Map('map');
	
	// Add controls for the map
	map.addControl(new OpenLayers.Control.Navigation());
	map.addControl(new OpenLayers.Control.PanPanel());
	map.addControl(new OpenLayers.Control.ZoomPanel());
	
	// Use Google Maps as the base layer
	var baseLayer = new OpenLayers.Layer.Google(
		"Google Hybrid",
		{type: google.maps.MapTypeId.HYBRID, numZoomLevels: 20, isBaseLayer:true}
	);
	
	// A layer for a user-drawn polygon
	//polyLayer = new OpenLayers.Layer.Vector("polyLayer");
 
	// Create the Viewport with a map panel, a tree panel and a legend panel
    var app = new Ext.Viewport({
        layout: "border",
        items: [{
			// The Map Panel
            region: "center",
            id: "mappanel",
            title: "WFS Map",
            xtype: "gx_mappanel",
            map: map,
			layers: [baseLayer],
            //layers: [baseLayer, polyLayer],
			// Transform the coordinates to Google Web Mercator to center map on US
			center: new OpenLayers.LonLat(-98.583, 39.833).transform(wgs84, googleMercator), 
			zoom: 5,
            split: true,
			tbar: CreateToolbar()
		}, {	
			// The Tree Panel
            region: "west",
            title: "Available Layers",
			xtype: "treepanel",
            width: 200,
			autoScroll: true,
            split: true,
			enableDD: true,
			collapsible: true,
			rootVisible: true,
			root: new GeoExt.tree.LayerContainer({
				text: 'Map Layers',
				expanded: true
			}),
			listeners: {
				// When a layer is clicked set that as the active layer and set the active features
				click: function(node, e) {
					SetActive(node);
				},
				// When a layer is checked, if that is the active layer, set the active features
				checkchange: function(node, e) {
					if (e == true && activeLayer != undefined) {
						//console.log(node);
						//console.log(activeLayer);
						if (node.layer.name == activeLayer.name)	
							SetActive(node);
					}
				}
			},
			tbar: CreateDataServicesToolbar(),
			bbar: CreateStatusbar()
		},{
			// The Legend Panel
			xtype: "gx_legendpanel",
			region: "east",
			title: "Legend",
			width: 200,
			autoScroll: true,
			padding: 5,
			collapsed: true,
			collapsible: true
        }]
    });
 });

// Create a html table in a new window for the feature data with the feature attributes as the headings
function ExportToHTMLTable() {
	//console.log(activeFeatures);
	// If a layer has been selected and turned on
	if ((activeFeatures != []) && (activeLayer != undefined)){
		if (activeFeatures.length == 0) 
			alert("There are no features selected on "+activeLayer.name+".");
		else {
			// Write the data as html
			var theHTML = "<html><title>"+activeLayer.name+"</title>";
			
			theHTML += "<head><style type='text/css'>td{width:200px; border-style:ridge; border-width:2px; border-color:#99bbe8; background:white}</style></head>";
			
			theHTML += "<body style=\"background-color:#c7dffc\"><table style='width:10000px; border-collapse:collapse; font:11px tahoma,arial,verdana,sans-serif'><tr>";

			// Set all attributes for the active layer
			SetAttributes(activeLayer.protocol.featureType);
		
			// Write the attributes to an html table as the column headings
			for (var i=0; i < layerAttributes.length; i++) {
				//console.log(layerAttributes[i].name);
				theHTML += "<th>"+layerAttributes[i].name+"</th>";
			}
			theHTML += "</tr>"; 

			// Write the feature data to the html table
			for (var i=0; i < activeFeatures.length; i++) {
				theHTML += "<tr>"; 
				for (var j=0; j < layerAttributes.length; j++) {
					var curColName = layerAttributes[j].name;
					var curRowData = activeFeatures[i].data;
					if ((curRowData[curColName]) == undefined)
						theHTML += "<td></td>";
					else
						theHTML += "<td>"+curRowData[curColName]+"</td>";
				}
				theHTML += "</tr>";
			}
			theHTML += "</table></body></html>";
			
			// Write the html to a new window
			var htmlWin = window.open("","myWindow");
			htmlWin.document.write(theHTML);
			htmlWin.document.close();
		}
	}
	else
		alert("Click on a feature layer to make it the active layer.");
}

// Set node paramater as the active layer and set the active features for that layer
function SetActive(node){
	//console.log("activeLayer name:");
	//console.log(node.layer.name);
	//console.log("node:");
	//console.log(node);
	//console.log(selFeatures);
	
	// Don't set the active layer if baselayer or a folder clicked
	if (node.text != "Map Layer" && node.text != "Google Hybrid" && node.text != "polyLayer"){
		if (node.layer.features != undefined) {
			// Set selected layer to the layer the user clicked
			activeLayer = node.layer;
			
			// No features have been selected so set all features in active layer as the active features
			if (selFeatures.length == 0){
				activeFeatures = activeLayer.features;
			}
			else{
				// Clear activeFeatures
				activeFeatures = [];
			
				// For each selected feature add it to activeFeatures only if in the active layer
				for (var i = 0; i < selFeatures.length; i++) {
					if (activeLayer.name == selFeatures[i].layer.name)
						activeFeatures.push(selFeatures[i]);
				}
				
				// If none of the selected features are in the active layer add all features in that layer to activeFatures
				if (activeFeatures.length == 0){
					activeFeatures = activeLayer.features;				
				}					
			}
		}
	}
	else {
		activeLayer = undefined;
		activeFeatures = [];
	}
	//console.log("activeFeatures:");
	//console.log(activeFeatures);
}

// Create the toolbar above the map with various actions               !!! ERRROR w TOGGLE & ZOOM ACTIVE LAYER !!!!
function CreateToolbar() {
var ctrl, action, toolbarItems = [], actions = {};

   // ZoomToMaxExtent
    action = new GeoExt.Action({
        control: new OpenLayers.Control.ZoomToMaxExtent(),
        map: map,
        text: "max extent",
        tooltip: "zoom to max extent"
    });
    actions["max_extent"] = action;
    toolbarItems.push(action);
    toolbarItems.push("-");
	
	// Zoom to active layer						     !!!!!!!!!!!!!!!!!!!!!!!!!!!! NOT WORKING !!!!!!!!!!!!!!!!!!!!!!!
 /*   action = new GeoExt.Action({
		//control: ZoomActiveLayer(),
		handler: function () {
			if (activeLayer != undefined){
				//console.log(activeLayer);													// Projection issue?
				//var bounds = new OpenLayers.Bounds("-113.1667, 31.5, -109.25, 36.5");    // Hardcoded for testing
				//map.zoomToExtent(bounds);
				new OpenLayers.Control.ZoomToMaxExtent();
				//new OpenLayers.Control.zoomToExtent(activeLayer.getDataExtent());
			}
			else
				alert("Click on a layer to make it the active layer.");
		},
        map: map,
		disabled: true,
        text: "zoom layer",
        tooltip: "zoom to active layer"
    });
    actions["zoom_layer"] = action;
    toolbarItems.push(action);
    toolbarItems.push("-");*/
	
	// Navigation history
    ctrl = new OpenLayers.Control.NavigationHistory();
    map.addControl(ctrl);

    action = new GeoExt.Action({
        text: "previous",
        control: ctrl.previous,
        disabled: true,
        tooltip: "previous in view history"
    });
    actions["previous"] = action;
    toolbarItems.push(action);

    action = new GeoExt.Action({
        text: "next",
        control: ctrl.next,
        disabled: true,
        tooltip: "next in view history"
    });
    actions["next"] = action;
    toolbarItems.push(action);
	toolbarItems.push("-");
	
	// Button to allow for the drawing of a polygon
/*	action = new GeoExt.Action({
		text: "draw poly",
		control: new OpenLayers.Control.DrawFeature(
			polyLayer, OpenLayers.Handler.Polygon
		),
		handler: PolyLayerSelect(),
		map: map,
		toggleGroup: "draw",
		allowDepress: true,
		tooltip: "draw polygon"
	});
    actions["draw_poly"] = action;
    toolbarItems.push(action);
	
	// Button to clear all selected features
	action = new GeoExt.Action({ 
        text: "clear poly",
        tooltip: "clear user-drawn polygon(s)",
        map: map,		
		handler: function(item, pressed) {
			polyLayer.destroyFeatures();
		}
    });
    actions["clear_poly"] = action;
    toolbarItems.push(action);
    toolbarItems.push("-");*/
	
	// Button to clear all selected features
	action = new GeoExt.Action({ 
        text: "clear all selected",
        tooltip: "clear all selected features",
        map: map,		
		handler: function(item, pressed) {
			if (selectCtrl != undefined) {
				selectCtrl.unselectAll();	
				selFeatures = [];
				if (activeLayer != undefined)
					activeFeatures = activeLayer.features;
			}
		}
    });
    actions["clear_selected"] = action;
    toolbarItems.push(action);
    toolbarItems.push("-");
	
	// Button to turn on/off popups       
	action = new Ext.Action({ 
        text: "show popups",
        tooltip: "show popups with feature data",
		enableToggle: true, 
		toggleHandler: function(button, state) {
			if (state == true)
				showPopups = true;
			else
				showPopups = false;
		}
    });
    actions["show_popups"] = action;
    toolbarItems.push(action);
    toolbarItems.push("-");	
	
	// Create an html table
	action = new GeoExt.Action({ 
        text: "create table",
        tooltip: "create html table of selected features from active layer",
        map: map,
		handler: function(item, pressed) {
			ExportToHTMLTable();		
			}
    });
    actions["create_html"] = action;
    toolbarItems.push(action);
    toolbarItems.push("-");	
	
    toolbarItems.push("->");	
	
	// Help drop-down menu
	action = new GeoExt.Action({
        text: "Help",
        tooltip: "Help",
		menu: new Ext.menu.Menu({
			items: [{
				text: "Using this application",
				handler: function(button, evt) {
					HelpUsingApp();
				}
			},{
				text: "Report Bug / Request Features",
				handler: function(button, evt) {
					helpBugsFeatures();
				}
			},{
				text: "About",
				handler: function(button, evt) {
					HelpAbout();
				}
			}]
		})
    });
	actions["Help"] = action;
    toolbarItems.push(action);
	
	return toolbarItems;
}

// Help Menu Item - Help using this application
function HelpUsingApp(){
	new Ext.Window({
		title: 'Using the Application',
		layout: 'fit',
		closable: true,
		closeAction: 'hide',
		maximizable: true,
		width: 500,
		height: 500,
		items: [{
			xtype: 'panel',
			autoScroll: true,
			html: '<b>WFS Map</b><br><br> This program displays features from a WFS on a map, allows for the selection of features, and creates a table of selected features.<br><br>  This program contains the following parts:<br> 1. The Data Service Toolbar<br> 2. The Layer Tree<br> 3. The Map Panel Toolbar<br> 4. The Map Panel<br> 5. The Legend<br><br>  <b>1. The Data Service Toolbar</b><br> The Data Service Toolbar allows for the selection of a Web Feature Service to retrieve. There are two options for specifying the location of a desired WFS.<br> 1. The Data Service Drop-down Menu - Select a data service from the drop-down menu and its layers will be added to the layer tree.<br> 2. Base Url Input - Click the button to the right of the data service drop-down menu. Input a base url as in the example. Press enter. Layers will be added to the tree.<br><br>  <b>2. The Layer Tree</b><br> The Layer Tree lists the layers that available to be show in the map. Check the box next to the layer name to retrieve the layer and make it visible. Uncheck the box to hide the layer. Drag and drop the layer names to change the order of the layers. Click on the name of a layer to highlight the layer in blue and set that layer as the active layer. The Layer Tree panel can be expanded or collapsed by clicking on the arrows. At the bottom of the layer tree panel is a status bar which indicates if a layer is currently loading.<br><br>  <b>3. The Map Panel Toolbar</b><br> The Map Panel Toolbar provides additonal functionality for the the Map Panel. It has the following capabilities:<br> max extent: Zoom to the max extent of the baselayer.<br> zoom layer: Zoom to the extent of the active layer.<br> previous/next: Navigate through the history of map views.<br> clear all selected: Unselect all selected features.<br> show popups: When depressed, clicking on a feature will bring up a popup with information about that feature. Close the popup window by clicking the feature again or by clicking the x in the corner of the popup window. create table: Create a table in another browser window containing the data for the selected features in the active layer. If no features are selected the records for all features in the active layer will retrieved.<br><br>  <b>4. The Map Panel</b><br> The Map Panel displays the locations of the features in the checked layer(s). The Map Panel has the following capabilities:<br> Adjust Zoom: Use the + or - buttons in the top left corner or double-click on an area to zoom in.<br> Pan: Click on the up/down, left/right buttons in the top left corner.<br> Select Feature(s): Click on a feature to select it. It will turn yellow. Alternatively, draw a box around the desired features.<br> Unselect Feature(s): Click on a feature to unselect it.<br><br>  <b>5. The Legend</b><br> The Legend is in a collapsible panel to the right of the map. Expand or collapse the legend by clicking on the arrows.'
			}
		]
	}).show();	
}

// Help Menu Item - Report Bugs/Request Features
function helpBugsFeatures(){
	new Ext.Window({
		title: 'Report Bugs/ Request Features',
		layout: 'fit',
		closable: true,
		closeAction: 'hide',
		maximizable: true,
		width: 500,
		height: 500,
		items: [{
			xtype: 'panel',
			autoScroll: true,
			html: '<b> Future Features </b> <br> 1. Integration with Catalog Services <br> 2. Advanced Layer Tree <br><br>  <br><br> Report a bug or request a feature:<br> <a href="mailto:jalisdairi@gmail.com?subject=WFSClient">Send Email</a>'
			}
		]
	}).show();	
}

// Help Menu Item - About this application
function HelpAbout(){
	new Ext.Window({
		title: 'About this Application',
		layout: 'fit',
		closable: true,
		closeAction: 'hide',
		maximizable: true,
		width: 500,
		height: 500,
		items: [{
			xtype: 'panel',
			autoScroll: true,
			html: 'Version 0.1<br> This program was created by Jessica Good Alisdairi for the Arizona Geological Survey. It is still under development.<br><br>  This program uses OpenLayers, GeoExt and ExtJs.<br> <a href="http://openlayers.org/">OpenLayers</a><br> <a href="http://http://geoext.org/">GeoExt</a><br> <a href="http://dev.sencha.com/deploy/ext-3.4.0/">Ext JS</a><br>'
			}
		]
	}).show();	
}

// Zoom to the feature extent of the active layer     !!!!!!!!! NOT BEING USED - fix !!!!!!!!!!!!!!!!!!!!!!!!!!!!!
function ZoomActiveLayer(){
	var zoomCtrl = [];
	if (activeLayer != undefined)
		zoomCtrl.push(new OpenLayers.Control.zoomToExtent(OpenLayers.Bounds(-113.1667, 31.5, -109.25, 36.5)));
	else
		alert("Click on a layer to make it the active layer.");
    
	//   map.zoomToExtent(bounds)
	//console.log(activeLayer);
	//	zoomCtrl.push(new OpenLayers.Control.zoomToExtent(activeLayer.getDataExtent()))}
	//console.log(zoomCtrl);
	return zoomCtrl[0];
}

// Create the toolbar for the data services combo box and the base url input box
function CreateDataServicesToolbar(){
	var dataServicesToolbar = [];
	
	// Create the Data Services combo box
	dataServicesToolbar.push([{
		width:			175,
		//width:        194,  // Width without the Url button
		xtype:          'combo',
		mode:           'local',
		value:          'Select a Data Service:',
		triggerAction:  'all',
		forceSelection: false,
		editable:       false,                                
		fieldLabel:     'Title',
		name:           'title',
		displayField:   'name',
		valueField: 	'value',
		store: 			new Ext.data.JsonStore({
			fields: ['name', 'value'],
			data: [
				//{name: 'AZActiveFaults', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/AZActiveFaults/MapServer/WFSServer'}, // !!!!!! PARSING ERRROR !!!!!
				{name: 'AZaqSpringChemistry', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/AZaqSpringChemistry/MapServer/WFSServer'},
				{name: 'AZaqWellChemistry', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/AZaqWellChemistry/MapServer/WFSServer'},
				{name: 'AZBoreholeTemperatures', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/AZBoreholeTemperatures/MapServer/WFSServer'},
				{name: 'AZDrillStemTests', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/AZDrillStemTests/MapServer/WFSServer'},
				{name: 'AZThermalSprings', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/AZThermalSprings/MapServer/WFSServer'},
				{name: 'AZVolcanicVents', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/AZVolcanicVents/MapServer/WFSServer'},
				{name: 'AZWellHeaders', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/AZWellHeaders/MapServer/WFSServer'},
				{name: 'AZWellLogs', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/AZWellLogs/MapServer/WFSServer'},
				{name: 'AZCaActiveFaults', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/CaActiveFaults/MapServer/WFSServer'},
				{name: 'CAaqSpringChemistry', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/CAaqSpringChemistry/MapServer/WFSServer'},
				{name: 'CAaqWellChemistry', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/CAaqWellChemistry/MapServer/WFSServer'},
				{name: 'CABoreholeTemperatures', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/CABoreholeTemperatures/MapServer/WFSServer'},
				{name: 'CAGeothermalAreas', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/CAGeothermalAreas/MapServer/WFSServer'},
				{name: 'CaThermalSprings', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/CaThermalSprings/MapServer/WFSServer'},
				{name: 'CAVolcanicVents', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/CAVolcanicVents/MapServer/WFSServer'},
				{name: 'CAWellHeaders', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/CAWellHeaders/MapServer/WFSServer'},
				{name: 'COaqSpringChemistry', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/COaqSpringChemistry/MapServer/WFSServer'},
				{name: 'COBoreholeTemperatures', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/COBoreholeTemperatures/MapServer/WFSServer'},
				{name: 'COThermalSprings', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/COThermalSprings/MapServer/WFSServer'},
				{name: 'FLBoreholeTemperatures', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/FLBoreholeTemperatures/MapServer/WFSServer'},
				{name: 'IDWellheaders', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/IDWellheaders/MapServer/WFSServer'},
				{name: 'NEBoreholeTemperatures', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/NEBoreholeTemperatures/MapServer/WFSServer'},
				{name: 'OKBoreholeLithIntervals', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/OKBoreholeLithIntervals/MapServer/WFSServer'},
				{name: 'OKBoreholeTemperatures', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/OKBoreholeTemperatures/MapServer/WFSServer'},
				{name: 'ORBoreholeTemperatures', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/ORBoreholeTemperatures/MapServer/WFSServer'},
				{name: 'ORThermalSprings', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/ORThermalSprings/MapServer/WFSServer'},
				{name: 'ORWellHeaders', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/ORWellHeaders/MapServer/WFSServer'},
				{name: 'TXBoreholeTemperatures', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/TXBoreholeTemperatures/MapServer/WFSServer'},
				{name: 'TXWellHeaders', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/TXWellHeaders/MapServer/WFSServer'},
				{name: 'UTActiveFaults', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/UTActiveFaults/MapServer/WFSServer'},
				{name: 'UTaqSpringChemistry', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/UTaqSpringChemistry/MapServer/WFSServer'},
				{name: 'UTBoreholeTemperatures', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/UTBoreholeTemperatures/MapServer/WFSServer'},
				{name: 'UTDrillStemTests', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/UTDrillStemTests/MapServer/WFSServer'},
				{name: 'UTThermalSprings', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/UTThermalSprings/MapServer/WFSServer'},
				{name: 'UTVolcanicVents', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/UTVolcanicVents/MapServer/WFSServer'},
				{name: 'WABoreholeLithIntervals', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/WABoreholeLithIntervals/MapServer/WFSServer'},
				{name: 'WAGeothermalAreas', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/WAGeothermalAreas/MapServer/WFSServer'},
				{name: 'WAWellLogs', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/WAWellLogs/MapServer/WFSServer'},
				{name: 'WYThermalSprings', value: 'http://services.azgs.az.gov/arcgis/services/aasggeothermal/WYThermalSprings/MapServer/WFSServer'}
			]
		}),
		listeners: {
			'select': function(combo, record){
				//console.log(record.data.name);
				Busy(record.data.name);
				GetCapabilities(this.getValue());
			}
		}
	}]);
	
	// Create a button with a text field for a user inputed base url
	dataServicesToolbar.push([{
		text: "Url",
	    //icon: 'http://localhost/Libraries/ext-3.4.0/examples/menu/list-items.gif', // icons can also be specified inline
        cls: 'x-btn-icon',
        tooltip: 'Enter a base url.',
		menu: new Ext.menu.Menu({
			items: [{
				text: 'Enter a base url, e.g. http://services.azgs.az.gov/arcgis/services/aasggeothermal/CAaqSpringChemistry/MapServer/WFSServer'
			},{
				xtype:'textfield',
				fieldLabel: 'Base Url',
				name: 'baseUrl',
				width: 650,
				listeners: {
					'specialkey': function(elem,evnt){
						// If the 'Enter' key is pressed get the layers for the url
						if(evnt.getKey() == 13)	{
							GetCapabilities(elem.el.dom.value);
						}
					}
				}
			}]
		})

	}]);
	
	return dataServicesToolbar;
}

// Requst the GetCapabilities XML from the server to determine available layers
function GetCapabilities(baseUrl){
	//console.log(usedUrls);
	// Don't make the request if the Url has been called previously
	if (!IsIn(usedUrls, baseUrl)){
		// Get the WFS Capabilities from the server
		try{
			OpenLayers.Request.GET({
				url: baseUrl+'?SERVICE=WFS&version=1.1.0&REQUEST=GetCapabilities&namespace=wfs',
				async: false,
				callback: function(resp){
					Ready();
					// Response OK
					if (resp.status == 200) {
						// Add the urls to the list of urls already called
						usedUrls.push(baseUrl);
					
						// Format the response as WFS Capabilities
						var CapFormat = new OpenLayers.Format.WFSCapabilities();
						var cap = CapFormat.read(resp.responseText);
						//console.log(cap)
						
						// Get the feature layers
						GetLayers(cap, baseUrl);
						//console.log(wfsLayers);
					}
					else if (resp.status == 404){
						alert("Requested resource not available.")
					}
					else{
						alert("Invalid url.");
					}
				}
			})
		}
		catch (e){
			Ready();
		}
	}
	else{
		Ready();
		alert("Data Service selected previously.");
	}
}

// Get the feature layers
function GetLayers(cap, baseUrl){
	// Get each feature layer listed in the capabilities
	for (var i = 0; i < cap.featureTypeList.featureTypes.length; i++) {
		var featureName = cap.featureTypeList.featureTypes[i].name;
		var featureNS = cap.featureTypeList.featureTypes[i].featureNS;
		var dataServiceTitle = cap.serviceIdentification.title;
		
		// Get the number of features in the layer
		var hits = GetHits(baseUrl, featureName);
		var r = true;
		if (hits > 500)
			r = confirm("There are "+hits+" "+featureName+" features which may take awhile to load. Continue?");
		if (hits == 0){
			alert("There were 0 "+featureName+" features returned. There may be a problem with the server.");
			//r = false;
		}
		
		if (r == true) {
			// Create the server request for the layer
			wfsLayers[j] = new OpenLayers.Layer.Vector(featureName+" ("+dataServiceTitle+")", {
				strategies: [new OpenLayers.Strategy.BBOX()],
				protocol: new OpenLayers.Protocol.WFS({
					//version: "1.1.0",                              !!!!!!!!!!!!!!!!!!!!!!!!  DOESN'T DRAW FEATURES w 1.1.0 !!!!!!!!!!!!!!!!!!
					url: baseUrl,
					featureType: featureName,
					featureNS: featureNS,
					geometryName: "shape"
				}),
				styleMap: SetStyle(),
				visibility: false
			});

			map.addLayers([wfsLayers[j]]);
			MakeSelectable();
			
			// Set the cursor to busy while the layer is loading
			wfsLayers[j].events.register("loadstart", wfsLayers[j], function (e) {
				Busy(e.object.protocol.featureType);
			});
			
			// Set the cursor back to the default after layer has been loaded
			wfsLayers[j].events.register("loadend", wfsLayers[j], function (e) {
				Ready();
				if ((e.object == undefined) || (e.object.features.length == 0))
					alert(featureName+" wasn't loaded correctly. There maybe a problem with the server.");
			});
			
			j++;
		}
	}	
}

// Call DescribeFeatureType to get list of attributes for the active layer
function SetAttributes(featureName){
	var baseUrl = activeLayer.protocol.url;
	OpenLayers.Request.GET({
		url: baseUrl+'?SERVICE=WFS&version=1.1.0&REQUEST=DescribeFeatureType&namespace=wfs'+'&typeName='+featureName,
		async: false,
		success: function(resp) {
			// Format the response as WFS Capabilities
			var DesFormat = new OpenLayers.Format.WFSDescribeFeatureType();
			var des = DesFormat.read(resp.responseText);
			
			// Get the number of attributes and the attributes themselves
			layerAttributes = des.featureTypes[0].properties;
		}
	});
}

// Request the number of hits (number of features) from the server
function GetHits(baseUrl, featureName){
	var hitsUrl = baseUrl + "?service=wfs&version=1.1.0&request=GetFeature&typeName="+featureName+"&resultType=hits";
	xmlHttp = new XMLHttpRequest();
	xmlHttp.open( "GET", hitsUrl, false );
	xmlHttp.send();

	if (xmlHttp.readyState==4 && xmlHttp.status==200) {
		var xmlHits = xmlHttp.responseXML.documentElement;
		var hits = xmlHits.attributes.getNamedItem("numberOfFeatures").nodeValue;
		return hits;
	}
	else 
		return 0;
}

// Select the features that intersect the user-drawn polygon(s)
function PolyLayerSelect(){
	polyLayer.events.on({
		"sketchcomplete": function(e) {
			wfsLayers.filter = new OpenLayers.Filter.Spatial({
				type: OpenLayers.Filter.Spatial.INTERSECTS,
				value: e.feature.geometry
			});
			//wfsLayers.filter.select();
			console.log(wfsLayers);
			console.log(wfsLayers.filter);
		}
	})
}

// Allow for selecting/unselecting a feature and set options	
function MakeSelectable(){
	selectCtrl = new OpenLayers.Control.SelectFeature(wfsLayers, {
		clickout: false, 
		toggle: true,
		multiple: true,
		hover: false,
		box: true
	});
	map.addControl(selectCtrl); 
	selectCtrl.activate();
	
	wfsLayers[j].events.on({
		"featureselected": function(e) {
			if (showPopups == true){
				CreatePopup(e.feature);
				}
			//console.log(e.feature);
			//console.log("selected feature "+e.feature.id+" on "+e.feature.layer.name);
			
			// Add the selected feature to the list of selected features
			selFeatures.push(e.feature);
			//console.log(selFeatures);
			
			// If an active layer has been set and if the selected feature is in the active layer add it to activeFeatures
			if (activeLayer != undefined) {
				if (e.feature.layer.name == activeLayer.name){
					// If all features of the layer had been added to activeFeatures
					// (ie. no individual features had been selected previously)
					// clear activeFeatures first
					if (activeLayer.features.length == activeFeatures.length) {
						activeFeatures = [];
					}
					activeFeatures.push(e.feature);
				}
			}
			//console.log("features:");
			//console.log(selFeatures);
			//console.log("activeFeatures:");
			//console.log(activeFeatures);
		},
		"featureunselected": function(e) {
			// If a popup has been opened, close it on unselect
			if (popup != undefined)
				popup.close();
				
			// Remove selected feature from features array
			selFeatures.splice(selFeatures.indexOf(e.feature), 1);
			//console.log(selFeatures);
			
			// If an active layer has been set and is the same layer as the layer of the feature that has just been unselected
			// Remove the feature from activeFeatures but if it was the feature in activeFeatures and activeFeatures is now empty
			// Then all features of the active layer are active features
			if (activeLayer != undefined) {
				if (e.feature.layer.name == activeLayer.name){
					activeFeatures.splice(activeFeatures.indexOf(e.feature), 1);
					if (activeFeatures.length == 0)
						activeFeatures = activeLayer.features;
				}
				//console.log(activeFeatures);
			}
		},
		"boxselectionend": function (e) {
			//console.log(e.feature);
			//console.log("selected feature "+e.feature.id+" on "+e.feature.layer.name);
			
			// Add the selected feature to the list of selected features
			selFeatures.push(e.feature);
			//console.log(selFeatures);
			
			// If an active layer has been set and is the same layer as the layer of the feature that has just been selected
			// add the feature to activeFeatures
			if (activeLayer != undefined) {
				if (e.feature.layer.name == activeLayer.name){
					// If all features of the layer had been added to activeFeatures
					// (ie. no individual features had been selected previously)
					// clear activeFeatures first
					if (activeLayer.features.length == activeFeatures.length) {
						activeFeatures = [];
					}
					activeFeatures.push(e.feature);
				}
			}
			//console.log("features:");
			//console.log(selFeatures);
			//console.log("activeFeatures:");
			//console.log(activeFeatures);
		}	
		//console.log(selFeatures);
	});
}

// Create a popup to display the data of the selected feature
function CreatePopup(feature){
	//console.log(feature);
	//var popupTitle = feature.layer.featureType;
	var popupTitle = feature.layer.name;
	var featureInfoHTML="";
	var featureInfo = feature.data;
	
	// Create the HTML for the popup from the feature's data
	for (var i in featureInfo){
		featureInfoHTML = featureInfoHTML+"<b>"+ i +"</b>: "+featureInfo[i]+"<br>";
	}
	//console.log(popupTitle);
	popup = new GeoExt.Popup({
            title: popupTitle,
            location: feature,
            width: 500,
			height: 300,
            html: featureInfoHTML,
			autoScroll: true,
            maximizable: true,
            collapsible: true
        });
    popup.show();
}

// Set the style for the feature points
function SetStyle(){

	var defaultStyle = new OpenLayers.Style({
		pointRadius: 5,
		fillColor: GetRandomColor(),
		strokeWidth: .5
	/*	},{                !!!!!!!!!!!!!!!!!!!!!!!!!!!! CHANGES THE TITLE DISPLAYED IN LEGEND FOR EACH FEATURE BUT THEN DOESN'T SHOW SYMBOL !!!!!!!!!!!!!
		rules: [new OpenLayers.Rule({
			name: "Hi"
		})] */
		});
		
	var selectStyle = new OpenLayers.Style({
		fillColor: "yellow",
		strokeColor: "black"
	});

	var style = new OpenLayers.StyleMap({
            'default': defaultStyle,
            'select': selectStyle
        });
	
	return style;
}

// Get a unique random color in Hex format		
function GetRandomColor(){
	var letters = '0123456789ABCDEF'.split('');
    var color = '#';
    for (var i = 0; i < 6; i++ ) {
        color += letters[Math.round(Math.random() * 15)];
    }
	
	// Check to see if the color has already been used and if not add the color to the usedColors array
	if (IsIn(usedColors, color))
		GetRandomColor();
	else
		usedColors.push(color);

    return color;
}

// Check if the object is in the array
function IsIn(arr, obj){
	for(var i=0; i<arr.length; i++) {
		if (arr[i] == obj) 
			return true;
	}
}

// Create the statusbar for displaying Ready or Loading
function CreateStatusbar(){
	var statusbar = [{
				xtype: 'tbtext', 
				id: 'statusbar', 
				text: 'Ready'
			}]; 
	return  statusbar;
}

// Set cursor to wait and statusbar to loading
function Busy(name){
	document.body.style.cursor = 'wait';
	// Set the status bar to show that something is processing:
	var sb = Ext.getCmp('statusbar');
	sb.setText("Loading "+name+" ...");
}

// Set cursor to default and statusbar to ready
function Ready(){
	document.body.style.cursor = 'default';
	var sb = Ext.getCmp('statusbar');
	sb.setText("Ready");
}

</script>
</head>
<body>
</body>
</html>